##### Load the dataset

    emails = read.csv("Data Files/energy_bids.csv", stringsAsFactors=FALSE)
    #Why are we using StringAsFactors ?

    str(emails)

    ## 'data.frame':    855 obs. of  2 variables:
    ##  $ email     : chr  "North America's integrated electricity market requires cooperation on environmental policies Commission for Environmental Coope"| __truncated__ "FYI -----Original Message----- From: \t\"Ginny Feliciano\" <gfeliciano@earthlink.net>@ENRON [mailto:IMCEANOTES-+22Ginny+20Felic"| __truncated__ "14:13:53 Synchronizing Mailbox 'Kean, Steven J.' 14:13:53 Synchronizing Hierarchy 14:13:53 Synchronizing Favorites 14:13:53 Syn"| __truncated__ "^ ----- Forwarded by Steven J Kean/NA/Enron on 03/02/2001 12:27 PM ----- Suzanne_Nimocks@mckinsey.com Sent by: Carol_Benter@mck"| __truncated__ ...
    ##  $ responsive: int  0 1 0 1 0 0 1 0 0 0 ...

##### Responsive emails

    table(emails$responsive)

    ## 
    ##   0   1 
    ## 716 139

    library(tm)

    ## Loading required package: NLP

##### Create corpus

    corpus = Corpus(VectorSource(emails$email))

    corpus[[1]]$content

    ## [1] "North America's integrated electricity market requires cooperation on environmental policies Commission for Environmental Cooperation releases working paper on North America's electricity market Montreal, 27 November 2001 -- The North American Commission for Environmental Cooperation (CEC) is releasing a working paper highlighting the trend towards increasing trade, competition and cross-border investment in electricity between Canada, Mexico and the United States. It is hoped that the working paper, Environmental Challenges and Opportunities in the Evolving North American Electricity Market, will stimulate public discussion around a CEC symposium of the same title about the need to coordinate environmental policies trinationally as a North America-wide electricity market develops. The CEC symposium will take place in San Diego on 29-30 November, and will bring together leading experts from industry, academia, NGOs and the governments of Canada, Mexico and the United States to consider the impact of the evolving continental electricity market on human health and the environment. \"Our goal [with the working paper and the symposium] is to highlight key environmental issues that must be addressed as the electricity markets in North America become more and more integrated,\" said Janine Ferretti, executive director of the CEC. \"We want to stimulate discussion around the important policy questions being raised so that countries can cooperate in their approach to energy and the environment.\" The CEC, an international organization created under an environmental side agreement to NAFTA known as the North American Agreement on Environmental Cooperation, was established to address regional environmental concerns, help prevent potential trade and environmental conflicts, and promote the effective enforcement of environmental law. The CEC Secretariat believes that greater North American cooperation on environmental policies regarding the continental electricity market is necessary to: *  protect air quality and mitigate climate change, *  minimize the possibility of environment-based trade disputes, *  ensure a dependable supply of reasonably priced electricity across North America *  avoid creation of pollution havens, and *  ensure local and national environmental measures remain effective. The Changing Market The working paper profiles the rapid changing North American electricity market. For example, in 2001, the US is projected to export 13.1 thousand gigawatt-hours (GWh) of electricity to Canada and Mexico. By 2007, this number is projected to grow to 16.9 thousand GWh of electricity. \"Over the past few decades, the North American electricity market has developed into a complex array of cross-border transactions and relationships,\" said Phil Sharp, former US congressman and chairman of the CEC's Electricity Advisory Board. \"We need to achieve this new level of cooperation in our environmental approaches as well.\" The Environmental Profile of the Electricity Sector The electricity sector is the single largest source of nationally reported toxins in the United States and Canada and a large source in Mexico. In the US, the electricity sector emits approximately 25 percent of all NOx emissions, roughly 35 percent of all CO2 emissions, 25 percent of all mercury emissions and almost 70 percent of SO2 emissions. These emissions have a large impact on airsheds, watersheds and migratory species corridors that are often shared between the three North American countries. \"We want to discuss the possible outcomes from greater efforts to coordinate federal, state or provincial environmental laws and policies that relate to the electricity sector,\" said Ferretti. \"How can we develop more compatible environmental approaches to help make domestic environmental policies more effective?\" The Effects of an Integrated Electricity Market One key issue raised in the paper is the effect of market integration on the competitiveness of particular fuels such as coal, natural gas or renewables. Fuel choice largely determines environmental impacts from a specific facility, along with pollution control technologies, performance standards and regulations. The paper highlights other impacts of a highly competitive market as well. For example, concerns about so called \"pollution havens\" arise when significant differences in environmental laws or enforcement practices induce power companies to locate their operations in jurisdictions with lower standards. \"The CEC Secretariat is exploring what additional environmental policies will work in this restructured market and how these policies can be adapted to ensure that they enhance competitiveness and benefit the entire region,\" said Sharp. Because trade rules and policy measures directly influence the variables that drive a successfully integrated North American electricity market, the working paper also addresses fuel choice, technology, pollution control strategies and subsidies. The CEC will use the information gathered during the discussion period to develop a final report that will be submitted to the Council in early 2002. For more information or to view the live video webcast of the symposium, please go to: http://www.cec.org/electricity. You may download the working paper and other supporting documents from: http://www.cec.org/programs_projects/other_initiatives/electricity/docs.cfm?varlan=english. Commission for Environmental Cooperation 393, rue St-Jacques Ouest, Bureau 200 MontrÃ©al (QuÃ©bec) Canada H2Y 1N9 Tel: (514) 350-4300; Fax: (514) 350-4314 E-mail: info@ccemtl.org ***********"

##### Transform case to lower and remove punctuation

    corpus = tm_map(corpus, content_transformer(tolower))
    corpus = tm_map(corpus, removePunctuation)
    corpus[[1]]$content

    ## [1] "north americas integrated electricity market requires cooperation on environmental policies commission for environmental cooperation releases working paper on north americas electricity market montreal 27 november 2001  the north american commission for environmental cooperation cec is releasing a working paper highlighting the trend towards increasing trade competition and crossborder investment in electricity between canada mexico and the united states it is hoped that the working paper environmental challenges and opportunities in the evolving north american electricity market will stimulate public discussion around a cec symposium of the same title about the need to coordinate environmental policies trinationally as a north americawide electricity market develops the cec symposium will take place in san diego on 2930 november and will bring together leading experts from industry academia ngos and the governments of canada mexico and the united states to consider the impact of the evolving continental electricity market on human health and the environment our goal with the working paper and the symposium is to highlight key environmental issues that must be addressed as the electricity markets in north america become more and more integrated said janine ferretti executive director of the cec we want to stimulate discussion around the important policy questions being raised so that countries can cooperate in their approach to energy and the environment the cec an international organization created under an environmental side agreement to nafta known as the north american agreement on environmental cooperation was established to address regional environmental concerns help prevent potential trade and environmental conflicts and promote the effective enforcement of environmental law the cec secretariat believes that greater north american cooperation on environmental policies regarding the continental electricity market is necessary to   protect air quality and mitigate climate change   minimize the possibility of environmentbased trade disputes   ensure a dependable supply of reasonably priced electricity across north america   avoid creation of pollution havens and   ensure local and national environmental measures remain effective the changing market the working paper profiles the rapid changing north american electricity market for example in 2001 the us is projected to export 131 thousand gigawatthours gwh of electricity to canada and mexico by 2007 this number is projected to grow to 169 thousand gwh of electricity over the past few decades the north american electricity market has developed into a complex array of crossborder transactions and relationships said phil sharp former us congressman and chairman of the cecs electricity advisory board we need to achieve this new level of cooperation in our environmental approaches as well the environmental profile of the electricity sector the electricity sector is the single largest source of nationally reported toxins in the united states and canada and a large source in mexico in the us the electricity sector emits approximately 25 percent of all nox emissions roughly 35 percent of all co2 emissions 25 percent of all mercury emissions and almost 70 percent of so2 emissions these emissions have a large impact on airsheds watersheds and migratory species corridors that are often shared between the three north american countries we want to discuss the possible outcomes from greater efforts to coordinate federal state or provincial environmental laws and policies that relate to the electricity sector said ferretti how can we develop more compatible environmental approaches to help make domestic environmental policies more effective the effects of an integrated electricity market one key issue raised in the paper is the effect of market integration on the competitiveness of particular fuels such as coal natural gas or renewables fuel choice largely determines environmental impacts from a specific facility along with pollution control technologies performance standards and regulations the paper highlights other impacts of a highly competitive market as well for example concerns about so called pollution havens arise when significant differences in environmental laws or enforcement practices induce power companies to locate their operations in jurisdictions with lower standards the cec secretariat is exploring what additional environmental policies will work in this restructured market and how these policies can be adapted to ensure that they enhance competitiveness and benefit the entire region said sharp because trade rules and policy measures directly influence the variables that drive a successfully integrated north american electricity market the working paper also addresses fuel choice technology pollution control strategies and subsidies the cec will use the information gathered during the discussion period to develop a final report that will be submitted to the council in early 2002 for more information or to view the live video webcast of the symposium please go to httpwwwcecorgelectricity you may download the working paper and other supporting documents from httpwwwcecorgprogramsprojectsotherinitiativeselectricitydocscfmvarlanenglish commission for environmental cooperation 393 rue stjacques ouest bureau 200 montrãal quãbec canada h2y 1n9 tel 514 3504300 fax 514 3504314 email infoccemtlorg "

##### Remove stop words and then stem the document

    corpus = tm_map(corpus, removeWords, stopwords("english"))

    corpus = tm_map(corpus, stemDocument)

    corpus[[1]]$content

    ## [1] "north america integr electr market requir cooper  environment polici commiss  environment cooper releas work paper  north america electr market montreal 27 novemb 2001   north american commiss  environment cooper cec  releas  work paper highlight  trend toward increas trade competit  crossbord invest  electr  canada mexico   unit state   hope   work paper environment challeng  opportun   evolv north american electr market will stimul public discuss around  cec symposium    titl   need  coordin environment polici trinat   north americawid electr market develop  cec symposium will take place  san diego  2930 novemb  will bring togeth lead expert  industri academia ngos   govern  canada mexico   unit state  consid  impact   evolv continent electr market  human health   environ  goal   work paper   symposium   highlight key environment issu  must  address   electr market  north america becom    integr said janin ferretti execut director   cec  want  stimul discuss around  import polici question  rais   countri can cooper   approach  energi   environ  cec  intern organ creat   environment side agreement  nafta known   north american agreement  environment cooper  establish  address region environment concern help prevent potenti trade  environment conflict  promot  effect enforc  environment law  cec secretariat believ  greater north american cooper  environment polici regard  continent electr market  necessari    protect air qualiti  mitig climat chang   minim  possibl  environmentbas trade disput   ensur  depend suppli  reason price electr across north america   avoid creation  pollut haven    ensur local  nation environment measur remain effect  chang market  work paper profil  rapid chang north american electr market  exampl  2001  us  project  export 131 thousand gigawatthour gwh  electr  canada  mexico  2007  number  project  grow  169 thousand gwh  electr   past  decad  north american electr market  develop   complex array  crossbord transact  relationship said phil sharp former us congressman  chairman   cec electr advisori board  need  achiev  new level  cooper   environment approach  well  environment profil   electr sector  electr sector   singl largest sourc  nation report toxin   unit state  canada   larg sourc  mexico   us  electr sector emit approxim 25 percent   nox emiss rough 35 percent   co2 emiss 25 percent   mercuri emiss  almost 70 percent  so2 emiss  emiss   larg impact  airsh watersh  migratori speci corridor   often share   three north american countri  want  discuss  possibl outcom  greater effort  coordin feder state  provinci environment law  polici  relat   electr sector said ferretti  can  develop  compat environment approach  help make domest environment polici  effect  effect   integr electr market one key issu rais   paper   effect  market integr   competit  particular fuel   coal natur gas  renew fuel choic larg determin environment impact   specif facil along  pollut control technolog perform standard  regul  paper highlight  impact   high competit market  well  exampl concern   call pollut haven aris  signific differ  environment law  enforc practic induc power compani  locat  oper  jurisdict  lower standard  cec secretariat  explor  addit environment polici will work   restructur market    polici can  adapt  ensur   enhanc competit  benefit  entir region said sharp  trade rule  polici measur direct influenc  variabl  drive  success integr north american electr market  work paper also address fuel choic technolog pollut control strategi  subsidi  cec will use  inform gather   discuss period  develop  final report  will  submit   council  earli 2002   inform   view  live video webcast   symposium pleas go  httpwwwcecorgelectr  may download  work paper   support document  httpwwwcecorgprogramsprojectsotherinitiativeselectricitydocscfmvarlanenglish commiss  environment cooper 393 rue stjacqu ouest bureau 200 montrãal quãbec canada h2i 1n9 tel 514 3504300 fax 514 3504314 email infoccemtlorg"

##### Create document matrix

    dtm = DocumentTermMatrix(corpus)
    dtm

    ## <<DocumentTermMatrix (documents: 855, terms: 22164)>>
    ## Non-/sparse entries: 102863/18847357
    ## Sparsity           : 99%
    ## Maximal term length: 156
    ## Weighting          : term frequency (tf)

##### Remove sparse terms

    dtm = removeSparseTerms(dtm, 0.97)
    dtm

    ## <<DocumentTermMatrix (documents: 855, terms: 788)>>
    ## Non-/sparse entries: 51612/622128
    ## Sparsity           : 92%
    ## Maximal term length: 19
    ## Weighting          : term frequency (tf)

    #we remove any term that doesn't appear in at least 3% of the documents.
    #To do that, we pass 0.97 to removeSparseTerms.

##### Create data frame

    labeledTerms = as.data.frame(as.matrix(dtm))

##### Add in the outcome variable

    labeledTerms$responsive = emails$responsive

    str(labeledTerms)

    ## 'data.frame':    855 obs. of  789 variables:
    ##  $ 100                : num  0 0 0 0 0 0 5 0 0 0 ...
    ##  $ 1400               : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ 1999               : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ 2000               : num  0 0 1 0 1 0 6 0 1 0 ...
    ##  $ 2001               : num  2 1 0 0 0 0 7 0 0 0 ...
    ##  $ 713                : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ 77002              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ abl                : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ accept             : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ access             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ accord             : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ account            : num  0 0 0 0 0 0 3 0 0 0 ...
    ##  $ act                : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ action             : num  0 0 0 0 1 0 0 0 0 0 ...
    ##  $ activ              : num  0 0 1 0 1 0 1 0 0 0 ...
    ##  $ actual             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ add                : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ addit              : num  1 0 0 0 0 0 1 0 0 0 ...
    ##  $ address            : num  3 0 0 0 2 0 0 0 0 1 ...
    ##  $ administr          : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ advanc             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ advis              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ affect             : num  0 0 0 0 2 0 0 0 0 0 ...
    ##  $ afternoon          : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ agenc              : num  0 0 0 0 1 0 0 0 0 0 ...
    ##  $ ago                : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ agre               : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ agreement          : num  2 0 0 0 2 0 1 0 0 1 ...
    ##  $ alan               : num  0 0 0 0 0 1 0 0 0 0 ...
    ##  $ allow              : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ along              : num  1 0 0 0 1 0 1 0 0 0 ...
    ##  $ alreadi            : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ also               : num  1 0 0 0 0 0 8 0 0 0 ...
    ##  $ altern             : num  0 0 0 0 0 0 0 0 1 0 ...
    ##  $ although           : num  0 0 0 0 0 0 6 0 0 0 ...
    ##  $ amend              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ america            : num  4 0 0 0 0 0 0 0 1 0 ...
    ##  $ among              : num  0 0 0 0 0 0 3 0 0 0 ...
    ##  $ amount             : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ analysi            : num  0 0 0 2 0 0 0 0 0 0 ...
    ##  $ analyst            : num  0 0 0 0 0 0 6 0 0 0 ...
    ##  $ andor              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ andrew             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ announc            : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ anoth              : num  0 0 0 0 0 0 6 0 0 0 ...
    ##  $ answer             : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ anyon              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ anyth              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ appear             : num  0 0 0 0 0 0 3 0 0 0 ...
    ##  $ appli              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ applic             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ appreci            : num  0 0 0 0 1 0 0 0 0 0 ...
    ##  $ approach           : num  3 0 0 0 0 0 1 0 0 0 ...
    ##  $ appropri           : num  0 0 0 0 0 0 0 1 0 0 ...
    ##  $ approv             : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ approxim           : num  1 0 0 0 0 0 1 0 0 0 ...
    ##  $ april              : num  0 0 0 0 0 0 3 0 0 0 ...
    ##  $ area               : num  0 0 0 0 1 0 3 0 0 0 ...
    ##  $ around             : num  2 0 0 0 0 0 1 0 0 0 ...
    ##  $ arrang             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ articl             : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ ask                : num  0 0 0 0 0 1 0 0 0 0 ...
    ##  $ asset              : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ assist             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ associ             : num  0 0 1 0 1 0 0 0 0 0 ...
    ##  $ assum              : num  0 0 0 0 0 1 0 0 0 0 ...
    ##  $ attach             : num  0 1 0 1 1 0 1 0 3 1 ...
    ##  $ attend             : num  0 0 0 0 0 0 0 0 1 0 ...
    ##  $ attent             : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ attorney           : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ august             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ author             : num  0 0 1 0 0 0 0 0 0 0 ...
    ##  $ avail              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ averag             : num  0 0 0 0 0 0 5 0 0 0 ...
    ##  $ avoid              : num  1 0 0 0 1 0 2 0 0 0 ...
    ##  $ awar               : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ back               : num  0 0 0 0 1 1 1 0 0 0 ...
    ##  $ balanc             : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ bank               : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ base               : num  0 0 0 0 1 0 9 0 0 0 ...
    ##  $ basi               : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ becom              : num  1 0 0 0 0 0 4 0 0 0 ...
    ##  $ begin              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ believ             : num  1 0 0 0 0 0 0 0 0 0 ...
    ##  $ benefit            : num  1 0 0 0 0 0 5 0 0 0 ...
    ##  $ best               : num  0 0 0 0 0 0 0 0 0 1 ...
    ##  $ better             : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ bid                : num  0 0 0 0 0 0 1 0 0 0 ...
    ##  $ big                : num  0 0 0 0 0 1 6 0 0 0 ...
    ##  $ bill               : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ billion            : num  0 0 0 0 0 0 2 0 0 0 ...
    ##  $ bit                : num  0 0 0 0 0 1 2 0 0 0 ...
    ##  $ board              : num  1 0 0 0 0 0 0 0 0 0 ...
    ##  $ bob                : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ book               : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ brian              : num  0 1 0 0 0 0 0 0 0 0 ...
    ##  $ brief              : num  0 0 0 0 0 0 0 0 0 0 ...
    ##  $ bring              : num  1 0 0 0 0 0 2 0 0 0 ...
    ##  $ build              : num  0 0 0 0 0 0 7 0 1 0 ...
    ##   [list output truncated]

##### Split the data

    library(caTools)

    set.seed(144)

    spl = sample.split(labeledTerms$responsive, 0.7)

    train = subset(labeledTerms, spl == TRUE)
    test = subset(labeledTerms, spl == FALSE)

##### Build a CART model

    library(rpart)
    library(rpart.plot)

    emailCART = rpart(responsive~., data=train, method="class")

    prp(emailCART)

![](Unit_5_Recitation_Enron_files/figure-markdown_strict/cart-1.png)<!-- -->
\#\#\#\#\# Make predictions on the test set

    pred = predict(emailCART, newdata=test)
    pred[1:10,]

    ##            0          1
    ## 2  0.2156863 0.78431373
    ## 5  0.9557522 0.04424779
    ## 11 0.9557522 0.04424779
    ## 13 0.8125000 0.18750000
    ## 28 0.4000000 0.60000000
    ## 37 0.9557522 0.04424779
    ## 47 0.9557522 0.04424779
    ## 58 0.9557522 0.04424779
    ## 61 0.1250000 0.87500000
    ## 62 0.1250000 0.87500000

    pred.prob = pred[,2]
    #Choosing second column only as it represents the responsive field

##### Compute accuracy

    table(test$responsive, pred.prob >= 0.5)

    ##    
    ##     FALSE TRUE
    ##   0   195   20
    ##   1    17   25

    sum(diag(table(test$responsive, pred.prob >= 0.5)))/nrow(test)

    ## [1] 0.8560311

    # Baseline model accuracy

    table(test$responsive)

    ## 
    ##   0   1 
    ## 215  42

    table(test$responsive)[2]/sum(table(test$responsive))

    ##         1 
    ## 0.1634241

##### ROC curve

    library(ROCR)

    ## Loading required package: gplots

    ## 
    ## Attaching package: 'gplots'

    ## The following object is masked from 'package:stats':
    ## 
    ##     lowess

    predROCR = prediction(pred.prob, test$responsive)

    perfROCR = performance(predROCR, "tpr", "fpr")

-r plot(perfROCR, colorize=TRUE)- \`\`\`

##### Compute AUC

    performance(predROCR, "auc")@y.values

    ## [[1]]
    ## [1] 0.7936323
